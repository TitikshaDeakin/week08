name: Backend CD - Deploy Backend Services to AKS

on:
  # Auto-run after Backend CI completes (kept)
  workflow_run:
    workflows: ["Backend CI - Test, Build and Push Images to ACR"]
    types: [completed]

  # NEW: allow running CD independently from the Actions UI
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

jobs:
  deploy_backend:
    # Allow if: (a) CI succeeded OR (b) this was started manually
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: Production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Kubeconfig setup (still using secret; OIDC would be a later fix) ---
      - name: Configure kubeconfig (if secret present)
        id: kubeconf
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ secrets.KUBECONFIG_B64 }}" ]]; then
            mkdir -p ~/.kube
            echo "${{ secrets.KUBECONFIG_B64 }}" | base64 --decode > ~/.kube/config
            echo "configured=true" >> "$GITHUB_OUTPUT"
          else
            echo "No kubeconfig secret found; will skip cluster actions."
            echo "configured=false" >> "$GITHUB_OUTPUT"

      # --- Probe cluster connectivity (non-fatal) ---
      - name: Verify cluster connection (non-fatal)
        id: ping
        shell: bash
        run: |
          set +e
          if [[ "${{ steps.kubeconf.outputs.configured }}" != "true" ]]; then
            echo "reachable=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          kubectl version --short >/dev/null 2>&1
          rc=$?
          if [[ $rc -eq 0 ]]; then
            echo "reachable=true" >> "$GITHUB_OUTPUT"
          else
            echo "reachable=false" >> "$GITHUB_OUTPUT"
          fi
          exit 0

      # --- Deploy infra + services only if cluster is reachable ---
      - name: Deploy backend infrastructure (ConfigMaps, Secrets, DBs)
        if: ${{ steps.ping.outputs.reachable == 'true' }}
        run: |
          set -euo pipefail
          kubectl apply -f k8s/configmaps.yaml
          kubectl apply -f k8s/secrets.yaml || true
          kubectl apply -f k8s/product-db.yaml
          kubectl apply -f k8s/order-db.yaml

      - name: Deploy backend microservices (Product, Order)
        if: ${{ steps.ping.outputs.reachable == 'true' }}
        run: |
          set -euo pipefail
          kubectl apply -f k8s/product-service.yaml
          kubectl apply -f k8s/order-service.yaml

      # --- Rollout validation (only when cluster reachable) ---
      - name: Validate rollouts
        if: ${{ steps.ping.outputs.reachable == 'true' }}
        run: |
          set -euo pipefail
          kubectl rollout status deployment/product-service --timeout=120s
          kubectl rollout status deployment/order-service  --timeout=120s

      # --- Capture external IPs and write a summary ---
      - name: Capture service external IPs
        id: ips
        if: ${{ steps.ping.outputs.reachable == 'true' }}
        shell: bash
        run: |
          PRODUCT_IP=$(kubectl get svc product-service-w08e1 -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
          ORDER_IP=$(kubectl get svc order-service-w08e1  -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
          echo "product_ip=${PRODUCT_IP}" >> "$GITHUB_OUTPUT"
          echo "order_ip=${ORDER_IP}"   >> "$GITHUB_OUTPUT"

      - name: Job summary (cluster reachable)
        if: ${{ steps.ping.outputs.reachable == 'true' }}
        run: |
          {
            echo "## Backend CD Summary"
            echo ""
            echo "- Product Service IP: **${{ steps.ips.outputs.product_ip || 'pending' }}**"
            echo "- Order Service IP: **${{ steps.ips.outputs.order_ip   || 'pending' }}**"
            echo ""
            echo "_Triggered by: **${{ github.event_name }}** (manual runs allowed via workflow_dispatch)._"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Job summary (no cluster)
        if: ${{ steps.ping.outputs.reachable != 'true' }}
        run: |
          {
            echo "## Backend CD Summary"
            echo ""
            echo "> Skipped cluster actions (no kubeconfig/cluster)."
            echo "> This is expected since Azure resources were removed for the assignment."
            echo ""
            echo "_Triggered by: **${{ github.event_name }}** (manual runs allowed via workflow_dispatch)._"
          } >> "$GITHUB_STEP_SUMMARY"
